{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Info Display</title>
    <style>
        #weather-container {
            display: flex;
            justify-content: space-around;
            padding: 20px;
        }
        .weather-box {
            border: 1px solid black;
            padding: 10px;
            width: 300px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Location Display</h1>
        <button onclick="window.location.href='{% url 'index' %}';">Return to Home</button>
    </header>
    <div id="weather-container">
        <div class="weather-box">
            <h2>Current Weather:</h2>
            <p>Weather:</p>
            <p>Temperature:</p>
            <p>Time:</p>
        </div>
        <div class="weather-box">
            <h2>Other day temperature</h2>
        </div>
    </div>
</body>
<script>
    // Function to fetch location from ipinfo.io and weather data from Open-Meteo
    async function fetchWeatherInfo() {
        try {
            // Get location data from ipinfo.io
            const ipinfoResponse = await fetch('https://ipinfo.io?token=6732adc15fee27');
            const ipinfoData = await ipinfoResponse.json();
            // Update the location header with the retrieved location
            updateLocationDisplay(ipinfoData.city, ipinfoData.region, ipinfoData.country);
            const [lat, lon] = ipinfoData.loc.split(',');

            // Fetch both current weather and the forecast
            const weatherData = await fetchWeather(lat, lon);

            // Update the UI with the weather data
            updateWeatherUI(weatherData);
        } catch (error) {
            console.error("Failed to fetch weather data:", error);
        }
    }

    // Function to fetch weather data for a given latitude and longitude
    async function fetchWeather(lat, lon) {
        // Include daily weather in the API endpoint
        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto`);
        const data = await response.json();
        return data;
    }

    // Function to update the location display
    function updateLocationDisplay(city, region, country) {
        const header = document.querySelector('header h1');
        header.textContent = `Location: ${city}, ${region}, ${country}`;
    }

    // Function to update the UI with fetched weather data
    function updateWeatherUI(data) {
        const weatherContainer = document.getElementById('weather-container');
        const currentWeatherBox = weatherContainer.children[0]; // Assuming the first box is for current weather
        const otherDaysBox = weatherContainer.children[1]; // Assuming the second box is for other days' weather

        // Update current weather
        // Convert weather code to description
        const weatherDescriptions = {
            0: 'Clear sky',
            1: 'Mainly clear',
            2: 'Partly cloudy',
            3: 'Overcast',
            // ... add other descriptions based on your weather code system
        };
        const weatherDescription = weatherDescriptions[data.current_weather.weathercode] || 'Not available';

        // Format the time to a more readable format
        const weatherTime = new Date(data.current_weather.time);
        const timeString = weatherTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });

        currentWeatherBox.innerHTML = `
            <h2>Current Weather:</h2>
            <p>Weather: ${weatherDescription}</p>
            <p>Temperature: ${data.current_weather.temperature}°C</p>
            <p>Time: ${timeString}</p>
        `;

        // Update other days' weather
        let otherDaysHTML = '<h2>Other day temperature</h2>';
        if (data.daily && data.daily.time) {
            for (let i = 0; i < data.daily.time.length; i++) {
                const date = new Date(data.daily.time[i]);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const maxTemp = data.daily.temperature_2m_max[i];
                const minTemp = data.daily.temperature_2m_min[i];

                otherDaysHTML += `
                    <p>${dayName}: Max: ${maxTemp}°C, Min: ${minTemp}°C</p>
                `;
            }
        }
        otherDaysBox.innerHTML = otherDaysHTML;
    }
            // New function to fetch weather for the user-entered city
        async function fetchWeatherForInputCity() {
            const city = document.getElementById('cityName').value.trim();
            if (city) {
                // Fetch weather data for the specified city
                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?city=${city}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto`);
                    if (response.ok) {
                        const data = await response.json();
                        updateWeatherUI(data);
                        // Update the location display manually with the entered city
                        updateLocationDisplay(city, "", "");
                    } else {
                        alert('Weather data for this city could not be retrieved.');
                    }
                } catch (error) {
                    console.error("Failed to fetch weather data for the city:", error);
                }
            } else {
                alert('Please enter a city name.');
            }
        }

    // Call the function to fetch weather information when the script loads
    fetchWeatherInfo();
</script>
</html>